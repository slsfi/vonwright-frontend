# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/), and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).



## [Unreleased]

### Added

- Config options to enable server-side rendering of the collection side menu and prebuild static versions of the menu: `config.app.ssr.collectionSideMenu` and `config.app.prebuild.staticCollectionMenus`. Both options are booleans. `config.app.ssr.collectionSideMenu` defaults to `false`, which means that rendering of the dynamic collection side menu is not performed on the server, but deferred to the browser. This increases performance on the server for projects that have very large collections (hundreds of texts/collection). `config.app.prebuild.staticCollectionMenus` defaults to `true`, which means that static HTML versions of each collection menu, in each project language, are generated when the Docker image of the app is built. The static collection menus are included in the server-side rendering of collection pages, and then replaced with the dynamic collection menus in the browser. This improves SEO of collection pages when server-side rendering of collection menus is disabled, without degrading the user experience. Setting both new options to `false` puts the least load on the server, but makes the web app less crawlable by robots. **Notice** that the static menus are generated during *build-time* – if the collection table of contents are updated in the backend, a new build has to be created for the changes to be reflected in the static menus.
- Config option to control the generation of a sitemap file in a prebuild step: `config.app.prebuild.sitemap`. Defaults to `true`.

### Changed

- Defer loading of the facsimile component on the collection text page to the browser. This increases server-side rendering performance since the component isn’t rendered on the server.
- Defer loading of the illustrations component on the collection text page to the browser. This increases server-side rendering performance since the component isn’t rendered on the server.
- Deps: update Angular to 17.1.3.
- Deps: update Ionic to 7.7.1.
- Deps: update `marked` to 11.2.0.
- Deps: update `@types/node` to 20.11.16.



## [1.2.3] – 2024-01-26

### Fixed

- Broken server-side rendering for non-default locales. Before this commit pages in non-default locales that used the `UrlService` were not rendered on the server. This was a side effect of the [`@jsonurl/jsonurl`](https://github.com/jsonurl/jsonurl-js) library used by the service to convert primitive data types and complex data structures like arrays, arrays of objects and objects with nested arrays and objects into URL-safe strings and vice versa. This fix removes the dependency on the external library and replaces its functionality with a custom conversion implementation. The custom implementation is not a full implementation of the [JSON→URL specification](https://github.com/jsonurl/specification/), but produces the same results for the parts that are relevant for this project. The code has been generated by ChatGPT-4 according to the JSON→URL specification, meticulously guided by a human mind. ([e4ff558](https://github.com/slsfi/digital-edition-frontend-ng/commit/e4ff5581b82efa2438a5eb3a03ce787bbfa0473b))



## [1.2.2] – 2024-01-25

### Changed

- Fix indentation in [`nginx.conf`](/nginx.conf). ([779b217](https://github.com/slsfi/digital-edition-frontend-ng/commit/779b21778e35591aa43cdddabf0f9682c9df40e7))
- Use `ARG` instructions in [`Dockerfile`](/Dockerfile) to define variables for setting Angular major version and Node image tag of the base image. This makes updating `Dockerfile` clearer as the Angular major version has to be changed in the file when the Angular major version of the app is updated. ([700b4e5](https://github.com/slsfi/digital-edition-frontend-ng/commit/700b4e53e574e937b36e8bd0b76546c798f7d5ab))
- Refactor functions and services related to markdown content. Remove duplicate code by moving functions for getting markdown content to the markdown service. Add pipe for marking HTML safe (bypassing sanitization) in order to separate the getting and parsing of markdown to HTML from the trusting of the HTML. Rename MarkdownContentService MarkdownService. ([a294791](https://github.com/slsfi/digital-edition-frontend-ng/commit/a294791f2946ec66d5b32557ba2f7d8ae030fe98))
- Replace `bypassSecurityTrustHtml` function calls with `trustHtml` pipe. ([b698c67](https://github.com/slsfi/digital-edition-frontend-ng/commit/b698c677f40dba5d073688e7d30e524e101bc63f))
- Run MathJax only in the browser. ([d92853c](https://github.com/slsfi/digital-edition-frontend-ng/commit/d92853c15435c07d40ed79ea1a2ef9cf9f98eb6e))
- Deps: update Angular to 17.1.1. ([3aba10e](https://github.com/slsfi/digital-edition-frontend-ng/commit/3aba10e41213d7e18a1af120f1ecd63eec2a4fda), [a3783f2](https://github.com/slsfi/digital-edition-frontend-ng/commit/a3783f2d6b4f6f30ef14b6766a22d524b8e60dd8))
- Deps: update Ionic to 7.6.6. ([1baa779](https://github.com/slsfi/digital-edition-frontend-ng/commit/1baa779dd2e4853d78513dffb2de4a19a5be5d44))
- Deps: update htmlparser2 to 9.1.0. ([3a28300](https://github.com/slsfi/digital-edition-frontend-ng/commit/3a28300a9b2594e1b3a8da3a92d1e8cb547292c2))
- Deps: update marked to 11.1.1 and remove @types/marked. Move markdown parsing to function in dedicated markdown service. ([2d214df](https://github.com/slsfi/digital-edition-frontend-ng/commit/2d214df0a76c5fd5d82e760b02ecbf9a9823b141))
- Deps: update zone.js to 0.14.3. ([9a33558](https://github.com/slsfi/digital-edition-frontend-ng/commit/9a335581bd6edaa84437b56b90866c440f9af714))
- Moved @angular/compiler from devDependencies to dependencies (like in fresh Angular 17 apps). ([c8a680d](https://github.com/slsfi/digital-edition-frontend-ng/commit/c8a680da970c5f27f76088186fe9555f0dcf98a5))
- Deps: update typescript to 5.3.3. ([c2ef241](https://github.com/slsfi/digital-edition-frontend-ng/commit/c2ef241c96610f915b201f272de5be07735852d9))
- Deps: update @types/node to 20.11.5. ([ba5a0ea](https://github.com/slsfi/digital-edition-frontend-ng/commit/ba5a0ea2a69721e7ece6d54b3bd803a153247200))
- Deps: update browser-sync to 3.0.2. ([7f65bed](https://github.com/slsfi/digital-edition-frontend-ng/commit/7f65bed1369ca517ce108ee6bf4e3ba7948b4c00))
- Deps: update jasmine-core to 5.1.1 and @types/jasmine to 5.1.4. ([b548e78](https://github.com/slsfi/digital-edition-frontend-ng/commit/b548e789674599298a79076136a5d98d404ed774))

### Removed

- Deps: angular-eslint from devDependencies. ([c719b45](https://github.com/slsfi/digital-edition-frontend-ng/commit/c719b45b41c93379f9819ad7d01e267c572ab52c))
- Deps: jasmine-spec-reporter from devDependencies. ([a9e0702](https://github.com/slsfi/digital-edition-frontend-ng/commit/a9e070215e15adb5f1078b688ab7bd347d316270))
- Deps: karma-coverage-istanbul-reporter from devDependencies. ([f27d677](https://github.com/slsfi/digital-edition-frontend-ng/commit/f27d6770d2623acea2f07067952edec0529976cd))
- Deps: ts-node from devDependencies. ([e55173f](https://github.com/slsfi/digital-edition-frontend-ng/commit/e55173f496db494fcd369b414efa1adf5353beb9))



## [1.2.1] – 2024-01-16

### Added

- Compression of static files. During the build step, static files of type `html`, `xml`, `txt`, `css`, `js`, `svg`, `ico`, `json`, `ttf` and `otf` in `dist/app/browser/` are precompressed using gzip. Files smaller than 1300 B are not compressed. If there is a compressed version of a static file, nginx is configured to serve it instead of the uncompressed file. The necessary directives for compressing dynamically generated HTML on-the-fly have also been added to the nginx configuration ([`nginx.conf`](/nginx.conf)), however, the directives have been commented out because of the increased server CPU load associated with on-the-fly compression. Each project can choose to enable the directives as they see fit. ([667b535](https://github.com/slsfi/digital-edition-frontend-ng/commit/667b535290b161648641d1c15c449bef01a1b9a8))

### Fixed

- Legacy setup code from Angular 15 to 17 migration. Angular 17 introduced several changes to the `app.module.\*`, `main.server.ts`, `main.ts`, `server.ts` and `tsconfig.\*` files. During the original v15 -> v17 update of the app all of these changes were not implemented. This fix attempts to align the app with the setup of a new modules based Angular 17 app that has SSR and i18n enabled. ([2b7c94d](https://github.com/slsfi/digital-edition-frontend-ng/commit/2b7c94d368adc51de871322ea1e4dcb3df74f5fd))



## [1.2.0] – 2024-01-10

### Added

- Config option to specify the dimensions of the site logo in the top menu: `config.component.topMenu.siteLogoDimensions` ([7402e28](https://github.com/slsfi/digital-edition-frontend-ng/commit/7402e280cae7c3f6472f7ca7c2a8e57f0795afa1)). The new config option is an object containing nested objects for specifying the height and width of the logo in both desktop and mobile mode. If the option is omitted, it defaults to an empty object, which corresponds to the old behaviour where the height and width attributes of the HTMLImageElement of the logo are not set. Setting the dimensions reduces layout shifts during page loading. Structure of the `siteLogoDimensions` with example values:

```
siteLogoDimensions: {
  default: {
    height: 56,
    width: 173
  },
  mobile: {
    height: 56,
    width: 56
  }
}
```

- Documentation on updating, building and deployment, as well as development. ([c329aa8](https://github.com/slsfi/digital-edition-frontend-ng/commit/c329aa8c0eaf357d948cb6ca75b9685b2e4f2134))

### Changed

- Default site logo in top menu changed to optimized PNG image file. Added both black and white versions of SLS’s logo to `assets/images/logo/`. ([9df4bef](https://github.com/slsfi/digital-edition-frontend-ng/commit/9df4bef940ddd66c6087daa93bee9fd166b4e731))
- Deps: update Angular dev-kit, CLI and SSR to 17.0.9. ([c67b22e](https://github.com/slsfi/digital-edition-frontend-ng/commit/c67b22e89fd459b850c523d679f1653ea5e2eaeb))
- Deps: update dev-dependency follow-redirects to 1.15.4. ([30355ea](https://github.com/slsfi/digital-edition-frontend-ng/commit/30355ea87e03c68c31df87ed34bb85cadd9e1f35))



## [1.1.1] – 2024-01-09

### Added

- nginx web server to serve static files in front of Node. This improves performance under load since 1) nginx is more performant than Node’s Express-server, 2) nginx’s performance is not impacted by Node being busy with server-side rendering tasks for dynamic content. ([8952fdc](https://github.com/slsfi/digital-edition-frontend-ng/commit/8952fdcdfece942363b37ef7567da7c344541382) by [@rasek-sls](https://github.com/rasek-sls))

### Changed

- Paths to font files in @font-face rules from absolute to relative. ([2dd2bf3](https://github.com/slsfi/digital-edition-frontend-ng/commit/2dd2bf34d76233f5eafc15e607a491a7800e1a38))
- Deps: update Ionic to 7.6.3 and Ionicons to 7.2.2. ([f35d148](https://github.com/slsfi/digital-edition-frontend-ng/commit/f35d14831bec9aa7430c43a4bd7854c3f77871b9))



## [1.1.0] – 2023-12-28

### Added

- Config option to show or hide the toggle for switching between the normalized and non-normalized version of manuscripts: `config.component.manuscripts.showNormalizedToggle`. The new config option defaults to `true`, which corresponds to the old behaviour. ([930eec2](https://github.com/slsfi/digital-edition-frontend-ng/commit/930eec227765d662726e2f9124d9763766fe73e2))
- Config option to add mandatory TEI class names to collection text HTML loaded from the backend: `config.collections.addTEIClassNames`. The new config option defaults to `true`, which corresponds to the old behaviour. If set to `false`, the class attributes of all HTML elements in reading texts, manuscripts and variants fetched from the backend, must contain the value `tei`. In addition, elements in comments must contain the class name `teiComment`, elements in manuscripts the class name `teiManuscript`, and elements in variants `teiVariant`. Otherwise, some inherent functionality and styles won’t work anymore for these texts. Setting the new config option to `false` improves app performance. ([df6554d](https://github.com/slsfi/digital-edition-frontend-ng/commit/df6554d6a7105b64dd109b308dc9c7ed82c274e5), [b8984f8](https://github.com/slsfi/digital-edition-frontend-ng/commit/b8984f8b7abf85f0c05438c4d2232776464538db))
- Config option to fix paths to the `assets/images/` folder in collection texts: `config.collections.replaceImageAssetsPaths`. The new config option defaults to `true`, which corresponds to the old behaviour. When this option is `true`, `src` attribute values starting with `images/` in the HTML of collection texts are replaced with `assets/images/`, which is the correct path to the image assets folder. Setting the new config option to `false` improves app performance. ([1f9d7ed](https://github.com/slsfi/digital-edition-frontend-ng/commit/1f9d7ed89135001dfececdea586f567d5c1388af))

### Changed

- Eagerly load home page banner image in portrait mode. ([5d11e3c](https://github.com/slsfi/digital-edition-frontend-ng/commit/5d11e3cce6b57335e8c6ae8816f5bd38aefa414f))
- Deps: update Angular to 17.0.8. ([e936d0b](https://github.com/slsfi/digital-edition-frontend-ng/commit/e936d0b097877cca2d61ff93ddee53b14583672b))
- Deps: update ng-extract-i18n-merge to 2.9.1. ([98e567b](https://github.com/slsfi/digital-edition-frontend-ng/commit/98e567b691d0e7c2550e2bbe5bc6015859e4798f))

### Fixed

- Show placeholder image for collections in the content grid on the content and home page if unable to retrieve collection cover image URL from the backend. Previously a missing cover image URL disrupted loading of all collections in the grid. ([3f3b256](https://github.com/slsfi/digital-edition-frontend-ng/commit/3f3b256d1926a982ff81fd704f1e36cd445182e4))

### Removed

- Trimming of collection texts fetched from backend. ([990a08c](https://github.com/slsfi/digital-edition-frontend-ng/commit/990a08c54b1207bcd3e290c3307d2d480901b8fe))



## [1.0.3] – 2023-12-14

### Added

- GitHub Actions workflow definition for triggering builds on commit push to `main` branch or new release/tag. ([aa32c39](https://github.com/slsfi/digital-edition-frontend-ng/commit/aa32c3941b335219f5e1d68ebbcb9ba6ece21312), [a5b22e7](https://github.com/slsfi/digital-edition-frontend-ng/commit/a5b22e7ca599b27fcf98e2996a8e40b9de801557), [a7be6c3](https://github.com/slsfi/digital-edition-frontend-ng/commit/a7be6c3b71e059af6192d03303064e6c2d219cf2), [00b19e4](https://github.com/slsfi/digital-edition-frontend-ng/commit/00b19e43a3270d83744f84e700e898df51b81c08) by [@rasek-sls](https://github.com/rasek-sls))

### Changed

- Update base app Docker image repository and tag in `compose.yml`. ([8bdfc5a](https://github.com/slsfi/digital-edition-frontend-ng/commit/8bdfc5a04b5e138ce12fafb69c7e90730dad73f9))
- Update README, CHANGELOG and build workflow code comments. ([35d373d](https://github.com/slsfi/digital-edition-frontend-ng/commit/35d373d67254638574483eae01f7a8a6415bba68))
- Deps: update Angular to 17.0.7. ([90028cf](https://github.com/slsfi/digital-edition-frontend-ng/commit/90028cfae667383603fd8852412ec7448ec6da5a))

### Fixed

- Remove incomplete regex sanitization of script tags in search query results. The regex sanitization is unnecessary because the query results are anyway parsed as HTML, only text nodes are retained and any `<`, `>` characters are converted to their corresponding HTML entities. ([ce54078](https://github.com/slsfi/digital-edition-frontend-ng/commit/ce540787c76c28554b241f140138531cb08ba6d2))



## [1.0.2] – 2023-12-11

### Changed

- Doodle illustrations must be placed in a media collection in the backend rather than in the hard coded `src/assets/images/verk/` folder in the frontend. Use `collections.mediaCollectionMappings` in `config.ts` to map the id of the collection with doodles to the id of the media collection that holds the images in the backend. ([9fd9d0e](https://github.com/slsfi/digital-edition-frontend-ng/commit/9fd9d0e7ab003e2d0dc3fd18c6e8c0edba88d7f5), [02d3d21](https://github.com/slsfi/digital-edition-frontend-ng/commit/02d3d21fbdc24f785e29db6a80acbe8409e91d0d))
- Illustration image path mapping to media collections is performed solely based on the presence of the CSS class name `est_figure_graphic` on `img` elements – not as previously based on the image `src` containing `assets/images/verk/` in it. Thus, illustration images that are to be mapped to media collections must have just the image file names in the `src` attributes, rather than `images/verk/<filename>` as previously. Images with absolute URLs in `src` are never mapped regardless of class names. ([2b4f4e6](https://github.com/slsfi/digital-edition-frontend-ng/commit/2b4f4e6fed6020562e0927c8a72969662a80e536))
- Fixing image paths in collection pages from `images/` to `assets/images/` is done specifically at the start of `src` attribute values – not for any occurrence of the string `images/`. ([111f902](https://github.com/slsfi/digital-edition-frontend-ng/commit/111f9022c4771f271cb812fc9c887c0faa93ece3))

### Removed

- Legacy settings from Angular configuration file. ([fbfc51c](https://github.com/slsfi/digital-edition-frontend-ng/commit/fbfc51c52b3681e265a28db0132b247fb3b136df))



## [1.0.1] – 2023-12-07

### Added

- Matching text color to page break toggle labels in the view options popover. ([514f999](https://github.com/slsfi/digital-edition-frontend-ng/commit/514f999d2fb4965a29a7253552c67f505f2394ee))

### Changed

- Apply background colors to toggle labels only instead of the entire toggles in the view options popover. ([fc2fc38](https://github.com/slsfi/digital-edition-frontend-ng/commit/fc2fc38c64d3c4d66c2838769f9cac74f0a72a08))
- Adjust padding of facsimile page number input elements to accommodate changed spec in Ionic 7.6.0. ([34d1ab0](https://github.com/slsfi/digital-edition-frontend-ng/commit/34d1ab074e03d386f01e6fe00e1fe5e0409dcfb5))
- Move inline styles for checkbox labels on the elastic-search page to the component SCSS-file. ([8d0a766](https://github.com/slsfi/digital-edition-frontend-ng/commit/8d0a76692396c77715fa570ac32e8f19bfd6b41a))
- Deps: update Ionic to 7.6.0. ([9c66917](https://github.com/slsfi/digital-edition-frontend-ng/commit/9c66917e8df33e96c5ac115aae618c6bce453c4a))
- Deps: update Angular to 17.0.6. ([bf878ae](https://github.com/slsfi/digital-edition-frontend-ng/commit/bf878aeeeb7a6100b81f4e1e808e7913806ec5b8))



## [1.0.0] – 2023-12-05

- Initial release.



[unreleased]: https://github.com/slsfi/digital-edition-frontend-ng/compare/1.2.3...HEAD
[1.2.3]: https://github.com/slsfi/digital-edition-frontend-ng/compare/1.2.2...1.2.3
[1.2.2]: https://github.com/slsfi/digital-edition-frontend-ng/compare/1.2.1...1.2.2
[1.2.1]: https://github.com/slsfi/digital-edition-frontend-ng/compare/1.2.0...1.2.1
[1.2.0]: https://github.com/slsfi/digital-edition-frontend-ng/compare/1.1.1...1.2.0
[1.1.1]: https://github.com/slsfi/digital-edition-frontend-ng/compare/1.1.0...1.1.1
[1.1.0]: https://github.com/slsfi/digital-edition-frontend-ng/compare/1.0.3...1.1.0
[1.0.3]: https://github.com/slsfi/digital-edition-frontend-ng/compare/v1.0.2...1.0.3
[1.0.2]: https://github.com/slsfi/digital-edition-frontend-ng/compare/v1.0.1...v1.0.2
[1.0.1]: https://github.com/slsfi/digital-edition-frontend-ng/compare/v1.0.0...v1.0.1
[1.0.0]: https://github.com/slsfi/digital-edition-frontend-ng/releases/tag/v1.0.0
